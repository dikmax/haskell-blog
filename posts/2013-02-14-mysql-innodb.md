---
title: MySQL, InnoDB и TEXT
date: 2013-02-14T10:18:32+03:00
tags: innodb, mysql, базы данных, программирование, работа
---

Совершенно неожиданная проблема вылезла со стороны InnoDB. При записи реальных данных в таблицу сервер начал выдавать ошибку 1118 --- “Row size too large”. 

Если кто не знает, MySQL хранит все данные вместе в одной строке-блоке, кроме данных типов TEXT и BLOB. Вместо них хранится ссылка на местоположение реальных данных. Вот и считаем сумму всех данных в строке — она не должна превышать некоторого значения. Если посмотреть в документации, можно увидеть, что максимальная длина строки для MyISAM — [64 килобайта](http://dev.mysql.com/doc/refman/5.5/en/column-count-limit.html), а для InnoDB — [около 8000 байт](http://dev.mysql.com/doc/refman/5.5/en/innodb-restrictions.html).

Я как-то уже встречался с подобной проблемой, поэтому представлял, что делать: открываем таблицу, смотрим типы колонок, разбираемся,  что можно заменить на TEXT или BLOB. Каково же было мое удивление, когда в нужной таблице оказалось 2 числовых поля и 40 полей с типом TEXT. Ну никак этот набор данных не может превышать 8Кб! Интерес добавляло еще то обстоятельство, что на тестовых небольших данных все работало, данные записывались и гармония царила.

Оказывается, у InnoDB два формата хранения данных — [Antelope](http://dev.mysql.com/doc/innodb/1.1/en/glossary.html#glos_antelope) и [Barracuda](http://dev.mysql.com/doc/innodb/1.1/en/glossary.html#glos_barracuda). И у Antelope есть интересная особенность: текстовые поля хранятся не совсем так, как мы привыкли думать. У них первые 768 байт попадают в саму строку и только затем, если данных оказалось больше, ставится ссылка на остаток. Понятное дело, что 768*40 значительно превышается отведенные 8 килобайт. Так же понятно, почему все хорошо работало на небольших объемах данных: все помещалось в строку и без всяких ссылок.

Мы решили эту проблему, выбросив все текстовые поля и заменив их одним, в котором все данных хранились в сериализованном виде. В интернете в качестве решения предлагался еще варианты разбить таблицу на несколько или сменить тип хранилица InnoDB.

Вот так живешь себе и не знаешь с какой стороны упадет сюрприз.
